// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== NEXTAUTH.JS MODELS ==========
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  emailVerified  DateTime? @map("email_verified")
  password       String?
  image          String?
  role           UserRole  @default(USER)
  organizationId String?   @map("organization_id")
  phone          String?
  jobTitle       String?   @map("job_title")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  accounts            Account[]
  sessions            Session[]
  organization        Organization?        @relation(fields: [organizationId], references: [id])
  warehouseStaff      WarehouseStaff[]
  checkOutsInitiated  CheckOut[]           @relation("CheckedOutBy")
  checkOutsReturned   CheckOut[]           @relation("ReturnedBy")
  transfersInitiated  InventoryTransfer[]
  reportsGenerated    Report[]
  scheduledReports    ScheduledReport[]
  tasksAssigned       Task[]
  notifications       Notification[]
  auditLogs           InventoryAuditLog[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// ========== MULTI-TENANT ORGANIZATION ==========
model Organization {
  id        String           @id @default(cuid())
  name      String
  slug      String           @unique
  plan      SubscriptionPlan @default(STARTER)
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  users              User[]
  settings           OrganizationSettings?
  warehouses         Warehouse[]
  inventoryItems     InventoryItem[]
  categories         Category[]
  checkOuts          CheckOut[]
  projects           Project[]
  clients            Client[]
  transfers          InventoryTransfer[]
  invoices           Invoice[]
  reports            Report[]
  scheduledReports   ScheduledReport[]
  tasks              Task[]

  @@map("organizations")
}

model OrganizationSettings {
  id             String @id @default(cuid())
  organizationId String @unique @map("organization_id")

  // Company Info
  companyName String?
  gstNumber   String? @map("gst_number")
  panNumber   String? @map("pan_number")
  address     String? @db.Text
  city        String?
  state       String?
  pinCode     String? @map("pin_code")
  phone       String?
  email       String?
  website     String?
  logo        String?

  // Preferences
  currency   String @default("INR")
  timezone   String @default("Asia/Kolkata")
  dateFormat String @default("DD/MM/YYYY") @map("date_format")

  // Notification Settings
  emailNotifications     Boolean @default(true) @map("email_notifications")
  lowStockAlerts         Boolean @default(true) @map("low_stock_alerts")
  maintenanceReminders   Boolean @default(true) @map("maintenance_reminders")
  projectUpdates         Boolean @default(true) @map("project_updates")
  paymentReminders       Boolean @default(false) @map("payment_reminders")
  weeklyReports          Boolean @default(true) @map("weekly_reports")

  // Thresholds
  lowStockThreshold      Int @default(10) @map("low_stock_threshold")
  criticalStockThreshold Int @default(5) @map("critical_stock_threshold")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

// ========== WAREHOUSE MANAGEMENT ==========
model Warehouse {
  id               String          @id @default(cuid())
  organizationId   String          @map("organization_id")
  name             String
  location         String
  address          String?         @db.Text
  city             String?
  state            String?
  pinCode          String?         @map("pin_code")
  capacity         Int
  currentOccupancy Int             @default(0) @map("current_occupancy")
  temperature      String?
  humidity         String?
  status           WarehouseStatus @default(ACTIVE)
  securityLevel    SecurityLevel   @default(MEDIUM) @map("security_level")
  manager          String?
  contactPhone     String?         @map("contact_phone")
  contactEmail     String?         @map("contact_email")
  floorPlanUrl     String?         @map("floor_plan_url")
  lastInspection   DateTime?       @map("last_inspection")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]
  locations      WarehouseLocation[]
  transfers      InventoryTransfer[]
  staff          WarehouseStaff[]

  @@index([organizationId])
  @@map("warehouses")
}

model WarehouseLocation {
  id          String   @id @default(cuid())
  warehouseId String   @map("warehouse_id")
  name        String
  zone        String?
  capacity    Int?
  positionX   Float?   @map("position_x")
  positionY   Float?   @map("position_y")
  createdAt   DateTime @default(now()) @map("created_at")

  warehouse Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  items     InventoryItem[]

  @@index([warehouseId])
  @@map("warehouse_locations")
}

model WarehouseStaff {
  id          String   @id @default(cuid())
  warehouseId String   @map("warehouse_id")
  userId      String   @map("user_id")
  role        String
  assignedAt  DateTime @default(now()) @map("assigned_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, userId])
  @@map("warehouse_staff")
}

// ========== INVENTORY ITEMS ==========
model InventoryItem {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  sku            String
  barcode        String?
  qrCode         String? @map("qr_code")
  name           String
  description    String? @db.Text
  categoryId     String  @map("category_id")
  warehouseId    String  @map("warehouse_id")
  locationId     String? @map("location_id")

  // Quantity
  totalQuantity     Int @default(1) @map("total_quantity")
  availableQuantity Int @default(1) @map("available_quantity")
  reservedQuantity  Int @default(0) @map("reserved_quantity")
  inUseQuantity     Int @default(0) @map("in_use_quantity")
  damagedQuantity   Int @default(0) @map("damaged_quantity")

  // Pricing
  purchasePrice     Decimal  @map("purchase_price") @db.Decimal(12, 2)
  rentalPriceDaily  Decimal? @map("rental_price_daily") @db.Decimal(12, 2)
  rentalPriceWeekly Decimal? @map("rental_price_weekly") @db.Decimal(12, 2)
  marketValue       Decimal? @map("market_value") @db.Decimal(12, 2)
  insuranceValue    Decimal? @map("insurance_value") @db.Decimal(12, 2)

  // Status
  status    ItemStatus    @default(AVAILABLE)
  condition ItemCondition @default(GOOD)

  // Dates
  purchaseDate        DateTime? @map("purchase_date")
  warrantyExpiry      DateTime? @map("warranty_expiry")
  lastMaintenanceDate DateTime? @map("last_maintenance_date")
  nextMaintenanceDate DateTime? @map("next_maintenance_date")

  // Metadata
  images         String[]
  documents      String[]
  tags           String[]
  notes          String?    @db.Text
  specifications Json?
  vendorType     VendorType @default(GENERAL) @map("vendor_type")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category        Category              @relation(fields: [categoryId], references: [id])
  warehouse       Warehouse             @relation(fields: [warehouseId], references: [id])
  location        WarehouseLocation?    @relation(fields: [locationId], references: [id])
  checkOuts       CheckOut[]
  maintenanceLogs MaintenanceLog[]
  projectItems    ProjectInventoryItem[]
  auditLogs       InventoryAuditLog[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([warehouseId])
  @@index([categoryId])
  @@index([status])
  @@map("inventory_items")
}

model Category {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  parentId       String?  @map("parent_id")
  icon           String?
  color          String?
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       Category?       @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]      @relation("CategoryHierarchy")
  items        InventoryItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("categories")
}

// ========== CHECK-OUT / CHECK-IN ==========
model CheckOut {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  itemId         String   @map("item_id")
  projectId      String?  @map("project_id")
  quantity       Int      @default(1)
  checkedOutBy   String   @map("checked_out_by")
  checkedOutAt   DateTime @default(now()) @map("checked_out_at")
  expectedReturn DateTime @map("expected_return")
  returnedBy     String?  @map("returned_by")
  returnedAt     DateTime? @map("returned_at")

  checkOutCondition ItemCondition   @map("check_out_condition")
  returnCondition   ItemCondition?  @map("return_condition")
  checkOutNotes     String?         @map("check_out_notes") @db.Text
  returnNotes       String?         @map("return_notes") @db.Text
  checkOutPhotos    String[]        @map("check_out_photos")
  returnPhotos      String[]        @map("return_photos")
  status            CheckOutStatus  @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  item           InventoryItem @relation(fields: [itemId], references: [id])
  project        Project?      @relation(fields: [projectId], references: [id])
  checkedOutUser User          @relation("CheckedOutBy", fields: [checkedOutBy], references: [id])
  returnedUser   User?         @relation("ReturnedBy", fields: [returnedBy], references: [id])

  @@index([organizationId])
  @@index([itemId])
  @@index([projectId])
  @@index([status])
  @@map("check_outs")
}

// ========== PROJECTS ==========
model Project {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  name           String
  description    String?       @db.Text
  clientId       String        @map("client_id")
  startDate      DateTime      @map("start_date")
  endDate        DateTime      @map("end_date")
  location       String?
  venue          String?
  status         ProjectStatus @default(PLANNING)
  priority       Priority      @default(MEDIUM)
  estimatedValue Decimal?      @map("estimated_value") @db.Decimal(12, 2)
  actualValue    Decimal?      @map("actual_value") @db.Decimal(12, 2)
  notes          String?       @db.Text
  tags           String[]
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client         Client                 @relation(fields: [clientId], references: [id])
  inventoryItems ProjectInventoryItem[]
  checkOuts      CheckOut[]
  tasks          Task[]
  invoices       Invoice[]

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

model ProjectInventoryItem {
  id         String   @id @default(cuid())
  projectId  String   @map("project_id")
  itemId     String   @map("item_id")
  quantity   Int      @default(1)
  assignedAt DateTime @default(now()) @map("assigned_at")

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  item    InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([projectId, itemId])
  @@map("project_inventory_items")
}

// ========== CLIENTS ==========
model Client {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  name           String
  contactPerson  String?    @map("contact_person")
  email          String?
  phone          String?
  address        String?    @db.Text
  city           String?
  state          String?
  pinCode        String?    @map("pin_code")
  type           ClientType @default(INDIVIDUAL)
  gstNumber      String?    @map("gst_number")
  panNumber      String?    @map("pan_number")
  rating         Float?
  totalProjects  Int        @default(0) @map("total_projects")
  totalRevenue   Decimal    @default(0) @map("total_revenue") @db.Decimal(12, 2)
  notes          String?    @db.Text
  tags           String[]
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]
  invoices     Invoice[]

  @@index([organizationId])
  @@map("clients")
}

// ========== MAINTENANCE ==========
model MaintenanceLog {
  id          String          @id @default(cuid())
  itemId      String          @map("item_id")
  type        MaintenanceType
  description String          @db.Text
  cost        Decimal?        @db.Decimal(10, 2)
  performedBy String?         @map("performed_by")
  performedAt DateTime        @default(now()) @map("performed_at")
  nextDueDate DateTime?       @map("next_due_date")
  notes       String?         @db.Text
  attachments String[]

  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("maintenance_logs")
}

// ========== TRANSFERS ==========
model InventoryTransfer {
  id                String         @id @default(cuid())
  organizationId    String         @map("organization_id")
  sourceWarehouseId String         @map("source_warehouse_id")
  destWarehouseId   String         @map("dest_warehouse_id")
  items             Json
  status            TransferStatus @default(PENDING)
  initiatedBy       String         @map("initiated_by")
  initiatedAt       DateTime       @default(now()) @map("initiated_at")
  completedAt       DateTime?      @map("completed_at")
  notes             String?        @db.Text

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sourceWarehouse Warehouse    @relation(fields: [sourceWarehouseId], references: [id])
  initiator       User         @relation(fields: [initiatedBy], references: [id])

  @@index([organizationId])
  @@map("inventory_transfers")
}

// ========== INVOICING ==========
model Invoice {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  clientId       String        @map("client_id")
  projectId      String?       @map("project_id")
  invoiceNumber  String        @map("invoice_number")
  items          Json
  subtotal       Decimal       @db.Decimal(12, 2)
  cgst           Decimal       @db.Decimal(12, 2)
  sgst           Decimal       @db.Decimal(12, 2)
  igst           Decimal       @db.Decimal(12, 2)
  total          Decimal       @db.Decimal(12, 2)
  status         InvoiceStatus @default(DRAFT)
  dueDate        DateTime?     @map("due_date")
  paidAt         DateTime?     @map("paid_at")
  gstNumber      String?       @map("gst_number")
  sacCode        String?       @map("sac_code")
  notes          String?       @db.Text
  pdfUrl         String?       @map("pdf_url")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id])
  project      Project?     @relation(fields: [projectId], references: [id])

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@map("invoices")
}

// ========== REPORTS ==========
model Report {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  name           String
  type           ReportType
  parameters     Json
  generatedBy    String     @map("generated_by")
  generatedAt    DateTime   @default(now()) @map("generated_at")
  fileUrl        String?    @map("file_url")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [generatedBy], references: [id])

  @@index([organizationId])
  @@map("reports")
}

model ScheduledReport {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  name           String
  type           ReportType
  frequency      String
  time           String
  recipients     String[]
  enabled        Boolean    @default(true)
  lastRunAt      DateTime?  @map("last_run_at")
  nextRunAt      DateTime?  @map("next_run_at")
  createdBy      String     @map("created_by")
  createdAt      DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [createdBy], references: [id])

  @@index([organizationId])
  @@map("scheduled_reports")
}

// ========== TASKS ==========
model Task {
  id             String     @id @default(cuid())
  organizationId String     @map("organization_id")
  projectId      String?    @map("project_id")
  title          String
  description    String?    @db.Text
  assignedTo     String?    @map("assigned_to")
  dueDate        DateTime?  @map("due_date")
  priority       Priority   @default(MEDIUM)
  status         TaskStatus @default(TODO)
  completedAt    DateTime?  @map("completed_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])
  assignee     User?        @relation(fields: [assignedTo], references: [id])

  @@index([organizationId])
  @@index([projectId])
  @@map("tasks")
}

// ========== NOTIFICATIONS ==========
model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

// ========== AUDIT LOGS ==========
model InventoryAuditLog {
  id        String   @id @default(cuid())
  itemId    String   @map("item_id")
  action    String
  userId    String   @map("user_id")
  changes   Json?
  timestamp DateTime @default(now())
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User          @relation(fields: [userId], references: [id])

  @@index([itemId])
  @@index([timestamp])
  @@map("inventory_audit_logs")
}

// ========== ENUMS ==========
enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  OPERATOR
  VIEWER
  USER
}

enum SubscriptionPlan {
  STARTER
  PROFESSIONAL
  BUSINESS
  ENTERPRISE
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  CLOSED
}

enum SecurityLevel {
  MAXIMUM
  HIGH
  MEDIUM
  LOW
}

enum ItemStatus {
  AVAILABLE
  IN_USE
  RESERVED
  MAINTENANCE
  DAMAGED
  RETIRED
}

enum ItemCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum VendorType {
  GENERAL
  ELECTRICAL
  STRUCTURES
  AV_EQUIPMENT
  DECOR
  FURNITURE
  CATERING
}

enum CheckOutStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

enum ProjectStatus {
  PLANNING
  EQUIPMENT_READY
  IN_PROGRESS
  COMPLETED
  PAUSED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ClientType {
  INDIVIDUAL
  CORPORATE
  AGENCY
  GOVERNMENT
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  EMERGENCY
  INSPECTION
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum ReportType {
  FINANCIAL
  INVENTORY
  UTILIZATION
  MAINTENANCE
  CLIENT
  PROJECT
  CUSTOM
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NotificationType {
  LOW_STOCK
  MAINTENANCE_DUE
  PROJECT_UPDATE
  CHECKOUT_OVERDUE
  PAYMENT_DUE
  SYSTEM
}
